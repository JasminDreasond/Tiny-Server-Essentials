# üìö `TinyExpress` Class - Documentation

A custom utility class for enhancing and managing behavior in Express-based HTTP servers. Includes CSRF setup, domain validation, IP extraction, and HTTP status code reference.

---

## üßæ Type Definitions

### üì• `Request`

Alias for `express.Request`.

### üî¢ `HttpStatusCode`

Represents a valid HTTP status code as a number.

### üåê `IPExtractor`

```ts
(req: Request) => string[]
```

A function that extracts a list of IPs from a request.

### üõ°Ô∏è `DomainValidator`

```ts
(req: Request) => boolean
```

A function that validates if the domain of a request matches a rule.

### üåç `OriginData`

Represents structured information parsed from an HTTP `Origin` header.

| Property   | Type     | Description                               |                               |
| ---------- | -------- | ----------------------------------------- | ----------------------------- |
| `raw`      | \`string | null\`                                    | The raw `Origin` header value |
| `protocol` | `string` | The protocol used (e.g., `http`, `https`) |                               |
| `hostname` | `string` | The hostname extracted from the origin    |                               |
| `port`     | `string` | The port used (default or explicit)       |                               |
| `full`     | `string` | The full reconstructed origin URL         |                               |
| `error`    | `string` | Any parsing error encountered             |                               |

---

## üèóÔ∏è Private Fields

### üîç `#domainTypeChecker`

```ts
string = "hostname"
```

Type of domain field to be validated (e.g., hostname).

### ‚õî `#forbiddenDomainMessage`

```ts
string = "Forbidden domain."
```

Message used when a domain is rejected.

### üß† `#ipExtractors`

```ts
{ [key: string]: IPExtractor }
```

Registry of IP extractor functions.

### ‚úÖ `#activeExtractor`

```ts
string = "DEFAULT"
```

Currently active IP extractor name.

### üõ°Ô∏è `#csrf`

```ts
{
  refreshCookieName: string,
  cookieName: string,
  headerName: string,
  errMessage: string,
  enabled: boolean,
  refreshInterval: number|null
}
```

CSRF protection configuration object.

* `refreshCookieName`: Name for the refresh token cookie
* `cookieName`: Name for the CSRF token cookie
* `headerName`: Header where CSRF token is expected
* `errMessage`: Error message on CSRF failure
* `enabled`: Whether CSRF is currently active
* `refreshInterval`: Time interval (ms) for CSRF refresh

### üß™ `#domainValidators`

```ts
{ [key: string]: DomainValidator }
```

A collection of validation functions per request property to validate incoming request domains.

---

## üì° `#httpCodes`

```ts
readonly { [statusCode: number|string]: string }
```

A lookup object for all standard and some common unofficial HTTP status codes with their descriptions. Includes:

* üìò Informational: `100‚Äì103`
* ‚úÖ Successful: `200‚Äì226`
* üîÅ Redirection: `300‚Äì308`
* ‚ùå Client errors: `400‚Äì451`
* üí• Server errors: `500‚Äì511`
* ‚òÅÔ∏è Cloudflare-specific unofficial codes: `520‚Äì526`

Example usage:

```js
tinyExpress.#httpCodes[404]; // "Not Found"
```

---

## üöÄ Constructor: `new TinyExpress(app?)`

Creates and initializes a new `TinyExpress` instance.

### üîß Features:

* ‚úÖ Injects domain validator middleware using `#domainTypeChecker`.
* üîí Automatically blocks invalid requests with `403 Forbidden`.
* üåÄ Registers loopback domains: `localhost`, `127.0.0.1`, and `::1`.
* üõ°Ô∏è Includes default domain validators for:

  * `x-forwarded-host`
  * `hostname`
  * `host`

```js
new TinyExpress(app);
```

**Parameters:**

* `app` *(optional)* ‚Äî an existing Express app. Defaults to `express()`.

---

## üß¨ `setCsrfOption(key, value)`

Modifies a CSRF config option (except for internal controls like `enabled`).

**Accepted keys:**

* `"cookieName"`
* `"headerName"`
* `"errMessage"`

```js
tiny.setCsrfOption('cookieName', 'csrf_token');
```

---

## ‚è±Ô∏è `setCsrfRefreshInterval(ms)`

Sets how often the CSRF token should refresh.

```js
tiny.setCsrfRefreshInterval(60000); // 1 minute
```

**Pass `null` to disable refresh.**

---

## üìã `geCsrftOptions()`

Returns a **shallow clone** of the current CSRF config.

```js
const config = tiny.geCsrftOptions();
```

---

## üç™ `installCsrfToken(bytes?, options?)`

Enables CSRF protection by generating and managing token cookies.

```js
tiny.installCsrfToken(32, {
  httpOnly: true,
  sameSite: 'strict',
  secure: true,
});
```

**Options:**

* `bytes`: token size in bytes (default `24`)
* `httpOnly`, `sameSite`, `secure`: cookie flags

---

## üîê `verifyCsrfToken()`

Express middleware to validate incoming CSRF tokens.

```js
app.use(tiny.verifyCsrfToken());
```

---

## üåç `getWeb()`

Returns the `TinyWebInstance`.

```js
const web = tiny.getWeb();
```

---

## üõ∞Ô∏è `getServer()`

Returns the current **HTTP/HTTPS server** instance.

```js
const server = tiny.getServer();
```

---

## üèóÔ∏è `getRoot()`

Returns the underlying Express application.

```js
const app = tiny.getRoot();
```

---

## ‚öôÔ∏è `init(web?)`

Initializes and links a `TinyWebInstance` (or raw server) to this wrapper.

```js
tiny.init(); // uses default TinyWebInstance
```

**Auto-registers:**

* Default domains (`localhost`, etc.)
* Header-based domain validators
* IP extractors (`ip`, `ips`, `remoteAddress`, etc.)

---

## üåê `getOrigin(req)`

üîç **Parses the `Origin` header** and returns a structured object.

```js
const originInfo = appManager.getOrigin(req);
```

Returns an object like:

```js
{
  raw: 'https://example.com',
  protocol: 'https',
  hostname: 'example.com',
  port: '443',
  full: 'https://example.com/'
}
```

If the header is invalid, the result includes:

```js
{ error: 'Invalid Origin header' }
```

---

## üß† IP Extractors

### `addIpExtractor(key, callback)`

‚ûï **Register a new IP extractor**.

```js
appManager.addIpExtractor('custom', (req) => extractIpList(req.headers['x-real-ip']));
```

> ‚ùó Key `"DEFAULT"` is reserved.

### `removeIpExtractor(key)`

‚ûñ **Remove a registered extractor**.

```js
appManager.removeIpExtractor('custom');
```

> ‚ùó You can't remove the one that's currently active.

### `getIpExtractors()`

üìã **List all registered extractors**.

```js
const extractors = appManager.getIpExtractors();
```

### `setActiveIpExtractor(key)`

üîÄ **Set which extractor to use**.

```js
appManager.setActiveIpExtractor('custom');
```

> Use `"DEFAULT"` to revert.

### `getActiveExtractor()`

üéØ **Returns the active extractor function.**

### `extractIp(req)`

üì• **Extract IP using the active strategy**.

```js
const ipList = appManager.extractIp(req); // returns array of strings
```

---

## üè∑Ô∏è Domain Validators

### `addDomainValidator(key, callback)`

‚ûï **Add a validator function** for a domain check.

```js
appManager.addDomainValidator('host', req => typeof req.headers.host === 'string' ? this.web.canDomain(req.headers.host) : false);
```

> ‚ùó `"ALL"` is reserved.

### `removeDomainValidator(key)`

‚ûñ **Remove a validator by key**.

> ‚ùó Cannot remove the one currently active unless using `"ALL"`.

### `getDomainValidators()`

üìã **Get all current domain validators.**

### `setDomainTypeChecker(key)`

üîß **Set which validator to use.**

```js
appManager.setDomainTypeChecker('host');
```

> `"ALL"` applies all validators simultaneously.

---

## üìü HTTP Codes and Responses

### `getHttpStatusMessage(code)`

üìñ **Get the default message for a status code.**

```js
const msg = appManager.getHttpStatusMessage(404); // 'Not Found'
```

### `hasHttpStatusMessage(code)`

‚ùì **Check if a status message exists.**

### `addHttpCode(code, message)`

‚ûï **Add a custom HTTP status code.**

```js
appManager.addHttpCode(799, 'Custom Status');
```

> üö´ Cannot overwrite existing codes.

### `sendHttpError(res, code)`

üì§ **Send a status error response.**

```js
appManager.sendHttpError(res, 404);
```

Adds header `HTTP/1.0 404 Not Found` and ends the response.

---

## üß∞ Express Middleware

### `installErrors(options)`

üîß **Set up error handling in your Express app**.

```js
appManager.installErrors({
  notFoundMsg: 'Oops! Nothing here.',
  errNext: (status, err, req, res) => {
    res.json({
      status,
      message: err.message,
      stack: process.env.NODE_ENV === 'development' ? err.stack : null,
    });
  }
});
```

Includes:

* `404` handler using `HttpError`
* Global error formatter (with dev stacktrace!)

---

## üîê `authRequest(req, res, next, options)`

Authenticate incoming HTTP requests using **Basic Auth**.

### ‚úÖ Use Case:

Protect routes with a username/password combo. Optionally, use a custom validator or a fallback error middleware.

### ‚öôÔ∏è Parameters:

| Name                | Type                                               | Description                                                       |
| ------------------- | -------------------------------------------------- | ----------------------------------------------------------------- |
| `req`               | `Request`                                          | Express request object.                                           |
| `res`               | `Response`                                         | Express response object.                                          |
| `next`              | `NextFunc`                                         | Passes control to the next middleware if authentication succeeds. |
| `options`           | `Object`                                           | Configuration object.                                             |
| `options.login`     | `string`                                           | Expected username.                                                |
| `options.password`  | `string`                                           | Expected password.                                                |
| `options.nextError` | `function` \| `null`                               | Optional error handler middleware.                                |
| `options.validator` | `(login, password) => boolean \| Promise<boolean>` | Optional credential validation logic.                             |

### üîÅ Behavior:

* ‚úÖ Calls `next()` if credentials match.
* ‚ùå Responds with `401 Unauthorized` and `WWW-Authenticate` if not.
* üéØ Falls back to `nextError` if provided.

---

## üìÑ `sendFile(res, options)`

Send a file (as a `Buffer`) with proper HTTP headers. Ideal for downloads. üì•

### ‚úÖ Use Case:

Respond with a downloadable file, or inline content like logs, text files, or binary assets.

### ‚öôÔ∏è Parameters:

| Name           | Type                               | Description                                           |
| -------------- | ---------------------------------- | ----------------------------------------------------- |
| `res`          | `Response`                         | Express response object.                              |
| `options`      | `Object`                           | File response config.                                 |
| `contentType`  | `string`                           | MIME type. Defaults to `'text/plain'`.                |
| `fileMaxAge`   | `number`                           | Cache-Control max-age in seconds. Defaults to `0`.    |
| `file`         | `Buffer`                           | File buffer to be sent. **Required.**                 |
| `lastModified` | `Date \| number \| string \| null` | Optional Last-Modified timestamp.                     |
| `fileName`     | `string \| null`                   | Filename for download. Enables `Content-Disposition`. |

### üìå Behavior:

* üì¶ Sets headers: `Content-Type`, `Content-Length`, `ETag`, `Last-Modified`, `Cache-Control`.
* üß† Automatically calculates `Content-MD5` hash.
* ‚è≥ If `fileMaxAge = 0`, disables caching.
* üìé If `fileName` is provided, sets it as `attachment`.

---

## üì∫ `streamFile(req, res, options)`

Stream a file or readable stream with support for **range requests**. Great for audio/video! üé•üéß

### ‚úÖ Use Case:

Serve large files with partial content support (`Range` headers), such as video playback.

### ‚öôÔ∏è Parameters:

| Name           | Type                               | Description                                          |
| -------------- | ---------------------------------- | ---------------------------------------------------- |
| `req`          | `Request`                          | Express request object (used to parse `Range`).      |
| `res`          | `Response`                         | Express response object.                             |
| `options`      | `Object`                           | Streaming config.                                    |
| `filePath`     | `string`                           | Full path to file on disk. Required if no stream.    |
| `stream`       | `ReadableStream`                   | Alternative to `filePath`. Custom stream source.     |
| `contentType`  | `string`                           | MIME type. Defaults to `'application/octet-stream'`. |
| `fileMaxAge`   | `number`                           | Cache-Control max-age. Defaults to `0`.              |
| `lastModified` | `Date \| number \| string \| null` | Optional Last-Modified timestamp.                    |
| `fileName`     | `string \| null`                   | Optional `Content-Disposition`. Can set `inline`.    |

### üìå Behavior:

* üéØ Detects `Range` header and sends partial content with `206`.
* üíΩ Full file streaming with `Content-Length` if no range requested.
* ‚öôÔ∏è Automatically sets headers: `Accept-Ranges`, `Last-Modified`, `Cache-Control`, and `Content-Disposition`.

---

## üß† Notes

* The `sendFile()` method is optimized for small/medium binary/text blobs that fit in memory.
* Use `streamFile()` for **streaming video, audio, or large files** efficiently.
* `authRequest()` supports both **static credentials** and **async validation** (e.g., DB or external checks).

---

## üß∞ Dependencies

* Node.js `fs` and `crypto` (for file handling and hashing)
* Express.js
